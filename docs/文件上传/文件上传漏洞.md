## 文件上传漏洞 

> 依赖信息收集，根据网站编程语言上传木马 

---

### 一、文件上传绕过前端检测 

- 在浏览器禁用`JavaScript`

### 二、文件上传绕过后端检测 

- `MIME`类型检测  `Content-Type` 

  > 绕过技巧：修改`Content-Type`为合法格式 
  
- 后缀名检测 

  - 黑名单检测 

    1、其他可解析后缀绕过： 
  
     - `.php3` 
     - `.php5` 
     - `.phtml` 
  
     2、配置文件绕过（针对Apache）：
  
     - 上传`.htaccess`文件，以调用`PHP`解释器解析`as.png` 
  
       ```php+HTML
       <FilesMtch "as.png">
       setHandler application/x-httpd-php
       </FilesMatch>
       ```
  
     3、点空格点绕过（利用Windows系统的文件名特性，会自动去掉后缀名最后的 `.` ,上传`as.php. .进行绕过` ）
  
     4、后缀大小写绕过（利用Windows系统对大小写不敏感，可以上传 `as.PHP` ）
  
     5、空格绕过（上传 `as.php ` 进行绕过） 
  
     6、点绕过（上传 `as.php.` 进行绕过，只在Windows系统生效） 
  
     7、`::$DATA` 绕过（上传 `as.php::$DATA` 绕过）
  
     8、双写后缀绕过（上传 `as.pphphp` ）
  
  - 白名单检测 
  
     1、%00截断绕过（0x00截断同理，区别在于上传路径显示位置不同）
    
     - 要求PHP版本 < 5.3.29且`php.ini`文件的`magic_quotes_gpc`的值为`off` 
     - 在POST 后面地址加上`xxx.php%00`并将上传格式改成合法格式 
    
  - 文件内容检测
  
     1、文件幻数绕过
    
     - 抓包改文件头  例：GIF89a<?php phpinfo();?>
     
     
    2、图片马绕过
    
    - 准备一张正常的图片和一个 `php` 文件，执行命令：
      
    >   ```cmd
    >   copy .\test.png/b + .\as.php/a as.png
    >   ```
    
     3、绕过二次渲染
    
     - 上传再下载比较二者文件幻数，查看哪里没变，在没变的位置插入木马。

### 三、其他绕过方式

- 条件竞争绕过 

  ```php
  <?php fputs(fopen('shell.php', 'w'), "<?php phpinfo();?>");?>
  ```

  上传上述代码文件，同时爆破上传文件访问和生成文件访问。

### 四、漏洞防御措施

- 上传的目录设置为不可执行。
- 对文件后缀的判断中使用白名单的方式。
- 文件服务器和web服务器分离，也就是上传的文件单独存放到其他的服务器之中。
- 不需要返回文件路径的情况下，随机改写文件名。
